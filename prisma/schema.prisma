// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma" // PlanetScale: manage relations in Prisma, not DB
}

// ---------- Enums ----------

enum MembershipRole {
  MEMBER
  MODERATOR
  OWNER
  ADMIN
}

enum RequestStatus {
  OPEN
  BOOKED
  COMPLETED
  CANCELLED
}

enum SlotStatus {
  OPEN
  BOOKED
  COMPLETED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS  // Added for check-in state
  COMPLETED
  CANCELLED
}

enum LedgerType {
  CREDIT
  DEBIT
  FEE
  ADJUSTMENT
}

enum CreditLotSource {
  EARNED
  PURCHASED
  BONUS
  GRANT
  LOAN
}

enum LotTier {
  BASIC
  PRIORITY
  GUARANTEED
}

enum RequestCategory {
  HOUSEHOLD_TASKS
  YARD_WORK
  PET_CARE
  CHILD_CARE
  ELDER_CARE
  TRANSPORTATION
  TECH_SUPPORT
  HOME_REPAIR
  MOVING_HELP
  ERRANDS
  COOKING
  TUTORING
  CREATIVE_PROJECTS
  EVENT_HELP
  OTHER
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

enum LoanStatus {
  ACTIVE
  REPAID
  DEFAULTED
}

enum ClaimStatus {
  SUBMITTED
  APPROVED
  DENIED
  PAID
}

enum DisputeStatus {
  OPEN
  RESOLVED
  REJECTED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

// ---------- Models ----------

model User {
  id           String  @id @default(cuid()) @db.VarChar(191)
  email        String  @unique @db.VarChar(191)
  passwordHash String
  name         String? @db.VarChar(191)
  city         String? @db.VarChar(191)
  avatarSeed   String? @db.VarChar(191)
  categories   Json?

  memberships     Membership[]
  requests        Request[]        @relation("RequestsByUser")
  bookings        Booking[]        @relation("BookingsByProvider")
  bookedSlots     Booking[]        @relation("BookingsByBooker")
  notifications   Notification[]
  disputesFiled   Dispute[]        @relation("DisputesFiled")
  disputesAgainst Dispute[]        @relation("DisputesAgainst")
  ownedCircles    Circle[]         @relation("CircleOwner")
  creditLots      CreditLot[]
  subscriptions   Subscription[]
  proProfile      ProProfile?
  loansBorrowed   Loan[]
  ledgerFrom      LedgerEntry[]    @relation("LedgerFromUser")
  ledgerTo        LedgerEntry[]    @relation("LedgerToUser")
  insuranceClaims InsuranceClaim[]
  invitesSent     CircleInvite[]   @relation("CircleInvitesSent")
  invitesUsed     CircleInvite[]   @relation("CircleInvitesUsed")
  joinRequests    JoinRequest[]    @relation("JoinRequestsByUser")
  joinRequestsReviewed JoinRequest[] @relation("JoinRequestsReviewed")
  offersAsHelper  Offer[]          @relation("OffersAsHelper")
  slotsAsProvider Slot[]           @relation("SlotsByProvider")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Circle {
  id          String  @id @default(cuid()) @db.VarChar(191)
  name        String  @db.VarChar(191)
  description String?
  city        String? @db.VarChar(191)
  ownerId     String  @db.VarChar(191)
  owner       User    @relation("CircleOwner", fields: [ownerId], references: [id])
  
  // Circle settings
  isPrivate     Boolean @default(false)  // Private = invitation only
  quietHours    Json?                   // {start: "22:00", end: "07:00"}
  allowsMinors  Boolean @default(true)
  demurrageRate Float   @default(0.0)   // % monthly credit decay
  categories    Json?                   // Enabled categories list
  invites       CircleInvite[]
  joinRequests  JoinRequest[]
  slots         Slot[]

  memberships   Membership[]
  requests      Request[]
  treasury      Treasury?
  insurance     InsurancePool?
  ledgerEntries LedgerEntry[]
  creditLots    CreditLot[]
  feeRules      FeeRule[]
  loans         Loan[]
  disputes      Dispute[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
}

model Membership {
  id             String         @id @default(cuid()) @db.VarChar(191)
  userId         String         @db.VarChar(191)
  circleId       String         @db.VarChar(191)
  role           MembershipRole @default(MEMBER)
  balanceCredits Int            @default(0)

  user   User   @relation(fields: [userId], references: [id])
  circle Circle @relation(fields: [circleId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, circleId])
  @@index([userId])
  @@index([circleId])
}

model CircleInvite {
  id          String    @id @default(cuid()) @db.VarChar(191)
  circleId    String    @db.VarChar(191)
  circle      Circle    @relation(fields: [circleId], references: [id])
  inviterId   String    @db.VarChar(191)
  inviter     User      @relation("CircleInvitesSent", fields: [inviterId], references: [id])
  token       String    @unique @db.VarChar(191) // Single-use token
  email       String?   @db.VarChar(191) // Optional: specific email invite
  usedById    String?   @db.VarChar(191)
  usedBy      User?     @relation("CircleInvitesUsed", fields: [usedById], references: [id])
  usedAt      DateTime?
  expiresAt   DateTime

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([circleId])
  @@index([token])
  @@index([inviterId])
}

model JoinRequest {
  id        String   @id @default(cuid()) @db.VarChar(191)
  circleId  String   @db.VarChar(191)
  circle    Circle   @relation(fields: [circleId], references: [id])
  userId    String   @db.VarChar(191)
  user      User     @relation("JoinRequestsByUser", fields: [userId], references: [id])
  message   String?  @db.Text
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewedBy String? @db.VarChar(191)
  reviewer   User?   @relation("JoinRequestsReviewed", fields: [reviewedBy], references: [id])
  reviewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, circleId])
  @@index([circleId])
  @@index([userId])
  @@index([status])
}

model Request {
  id          String        @id @default(cuid()) @db.VarChar(191)
  circleId    String        @db.VarChar(191)
  userId      String        @db.VarChar(191) // requester
  title       String        @db.VarChar(191)
  description String?       @db.Text
  status      RequestStatus @default(OPEN)
  
  // New fields for enhanced request system
  category           RequestCategory
  photoBase64        String?         @db.LongText // Base64 encoded photo
  effortLevel        Int             @default(3) // 1-5 scale
  creditsOffered     Int             // Auto-calculated from effort
  tier              LotTier         @default(BASIC)
  
  // Time constraints  
  timeWindowStart   DateTime?       // When help is needed (start)
  timeWindowEnd     DateTime?       // When help is needed (end)
  expiresAt         DateTime?       // When request expires if not filled
  
  // Location
  locationRadius    Float?          // km radius for in-person help
  address           String?         @db.VarChar(500) // Optional specific address
  city              String?         @db.VarChar(191) // City for map markers
  
  // Equipment/special requirements
  equipmentNeeded   Json?           // Array of equipment flags
  specialRequirements String?       @db.Text

  circle   Circle    @relation(fields: [circleId], references: [id])
  user     User      @relation("RequestsByUser", fields: [userId], references: [id])
  slots    Slot[]
  bookings Booking[]
  offers   Offer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([circleId])
  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([tier])
  @@index([city])
  @@index([expiresAt])
}

model Offer {
  id        String      @id @default(cuid()) @db.VarChar(191)
  requestId String      @db.VarChar(191)
  helperId  String      @db.VarChar(191)
  status    OfferStatus @default(PENDING)
  
  message          String?   @db.Text // Helper's note
  proposedStartAt  DateTime? // When helper can start
  estimatedHours   Float?    // How long helper thinks it will take
  
  // Contact info revealed after acceptance
  helperPhone      String?   @db.VarChar(50)
  helperEmail      String?   @db.VarChar(191)
  
  request Request @relation(fields: [requestId], references: [id])
  helper  User    @relation("OffersAsHelper", fields: [helperId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([requestId, helperId]) // One offer per helper per request
  @@index([requestId])
  @@index([helperId])
  @@index([status])
}

model Slot {
  id        String     @id @default(cuid()) @db.VarChar(191)
  requestId String?    @db.VarChar(191) // Optional - can be standalone SlotShop slot
  providerId String    @db.VarChar(191) // User offering availability
  circleId  String     @db.VarChar(191) // Circle where slot is available
  
  start     DateTime
  end       DateTime
  location  String?    @db.VarChar(191)
  status    SlotStatus @default(OPEN)
  
  // SlotShop specific fields
  title            String?           @db.VarChar(191)
  description      String?           @db.Text
  category         RequestCategory?  // What kind of help offered
  pricePerMinute   Int              @default(1) // Credits per minute
  minDuration      Int              @default(5) // Minimum booking duration in minutes
  maxDuration      Int?             // Maximum booking duration in minutes
  
  // Relations
  request  Request?  @relation(fields: [requestId], references: [id])
  provider User     @relation("SlotsByProvider", fields: [providerId], references: [id])
  circle   Circle   @relation(fields: [circleId], references: [id])
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requestId])
  @@index([providerId])
  @@index([circleId])
  @@index([status])
  @@index([start, end]) // For time-based queries
  @@index([category])
}

model Booking {
  id         String        @id @default(cuid()) @db.VarChar(191)
  requestId  String?       @db.VarChar(191) // Optional - can be standalone slot booking
  slotId     String        @db.VarChar(191)
  providerId String        @db.VarChar(191) // user who fulfills
  bookerId   String        @db.VarChar(191) // user who books (different from provider)
  status     BookingStatus @default(PENDING)
  
  // SlotShop specific fields
  duration       Int?              // Booked duration in minutes
  totalCredits   Int?              // Total credits for this booking
  actualStart    DateTime?         // When the booking actually started
  actualEnd      DateTime?         // When the booking actually ended
  bookerNotes    String?           @db.Text // Notes from the booker
  providerNotes  String?           @db.Text // Notes from the provider
  
  // Completion fields
  completionNotes        String?    @db.Text // Completion notes
  completionPhotoBase64  String?    @db.LongText // Optional completion photo
  bookerThanks          String?     @db.Text // Thank you from booker
  providerThanks        String?     @db.Text // Thank you from provider
  checkinLatitude       Float?      // Geolocation at check-in
  checkinLongitude      Float?      // Geolocation at check-in
  completedAt           DateTime?   // When marked as completed

  request         Request?         @relation(fields: [requestId], references: [id])
  slot            Slot             @relation(fields: [slotId], references: [id])
  provider        User             @relation("BookingsByProvider", fields: [providerId], references: [id])
  booker          User             @relation("BookingsByBooker", fields: [bookerId], references: [id])
  ledger          LedgerEntry[]
  insuranceClaims InsuranceClaim[]
  disputes        Dispute[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requestId])
  @@index([slotId])
  @@index([providerId])
  @@index([bookerId])
  @@index([status])
}

model LedgerEntry {
  id         String     @id @default(cuid()) @db.VarChar(191)
  circleId   String     @db.VarChar(191)
  bookingId  String?    @db.VarChar(191)
  fromUserId String?    @db.VarChar(191)
  toUserId   String?    @db.VarChar(191)
  amount     Int
  type       LedgerType
  meta       Json?

  circle  Circle   @relation(fields: [circleId], references: [id])
  booking Booking? @relation(fields: [bookingId], references: [id])
  from    User?    @relation("LedgerFromUser", fields: [fromUserId], references: [id])
  to      User?    @relation("LedgerToUser", fields: [toUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([circleId])
  @@index([bookingId])
  @@index([fromUserId])
  @@index([toUserId])
}

model CreditLot {
  id        String          @id @default(cuid()) @db.VarChar(191)
  userId    String          @db.VarChar(191)
  circleId  String          @db.VarChar(191)
  amount    Int
  remaining Int
  source    CreditLotSource
  tier      LotTier
  expiresAt DateTime?

  user   User   @relation(fields: [userId], references: [id])
  circle Circle @relation(fields: [circleId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([circleId])
}

model FeeRule {
  id         String  @id @default(cuid()) @db.VarChar(191)
  circleId   String  @db.VarChar(191)
  name       String  @db.VarChar(191)
  percentBps Int? // basis points, e.g., 250 = 2.5%
  flatFee    Int? // in credits
  appliesTo  String? @db.VarChar(191) // e.g., 'booking', 'transfer'
  active     Boolean @default(true)

  circle Circle @relation(fields: [circleId], references: [id])

  @@index([circleId])
}

model Subscription {
  id               String             @id @default(cuid()) @db.VarChar(191)
  userId           String             @db.VarChar(191)
  status           SubscriptionStatus @default(ACTIVE)
  plan             String             @db.VarChar(191)
  currentPeriodEnd DateTime?
  stripeCustomerId String?            @db.VarChar(191)
  stripeSubId      String?            @db.VarChar(191)

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model ProProfile {
  id         String  @id @default(cuid()) @db.VarChar(191)
  userId     String  @unique @db.VarChar(191)
  bio        String?
  skills     Json?
  hourlyRate Int? // in credits

  user User @relation(fields: [userId], references: [id])
}

model Treasury {
  id              String @id @default(cuid()) @db.VarChar(191)
  circleId        String @unique @db.VarChar(191)
  balanceCredits  Int    @default(0)
  reservedCredits Int    @default(0)

  circle Circle @relation(fields: [circleId], references: [id])
}

model Loan {
  id         String     @id @default(cuid()) @db.VarChar(191)
  circleId   String     @db.VarChar(191)
  borrowerId String     @db.VarChar(191)
  principal  Int
  remaining  Int
  status     LoanStatus @default(ACTIVE)

  circle   Circle @relation(fields: [circleId], references: [id])
  borrower User   @relation(fields: [borrowerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([circleId])
  @@index([borrowerId])
  @@index([status])
}

model InsurancePool {
  id         String @id @default(cuid()) @db.VarChar(191)
  circleId   String @unique @db.VarChar(191)
  balance    Int    @default(0)
  premiumBps Int? // basis points for premiums

  circle Circle           @relation(fields: [circleId], references: [id])
  claims InsuranceClaim[]
}

model InsuranceClaim {
  id        String      @id @default(cuid()) @db.VarChar(191)
  poolId    String      @db.VarChar(191)
  userId    String      @db.VarChar(191)
  bookingId String?     @db.VarChar(191)
  amount    Int
  status    ClaimStatus @default(SUBMITTED)
  notes     String?

  pool    InsurancePool @relation(fields: [poolId], references: [id])
  user    User          @relation(fields: [userId], references: [id])
  booking Booking?      @relation(fields: [bookingId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([poolId])
  @@index([userId])
  @@index([status])
}

model Dispute {
  id         String        @id @default(cuid()) @db.VarChar(191)
  circleId   String        @db.VarChar(191)
  bookingId  String        @db.VarChar(191)
  filedById  String        @db.VarChar(191)
  againstId  String        @db.VarChar(191)
  status     DisputeStatus @default(OPEN)
  reason     String?
  resolution String?

  circle  Circle  @relation(fields: [circleId], references: [id])
  booking Booking @relation(fields: [bookingId], references: [id])
  filedBy User    @relation("DisputesFiled", fields: [filedById], references: [id])
  against User    @relation("DisputesAgainst", fields: [againstId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([circleId])
  @@index([bookingId])
  @@index([filedById])
  @@index([againstId])
  @@index([status])
}

model Notification {
  id      String  @id @default(cuid()) @db.VarChar(191)
  userId  String  @db.VarChar(191)
  type    String  @db.VarChar(191)
  read    Boolean @default(false)
  payload Json?

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([read])
}
